---
TCP/IP 详解卷一 协议
---

#### 目录

1. 第十章 用户数据报协议和 IP 分片
2. 第十二章 传输控制协议
3. 第十三章 TCP 连接管理

#### 用户数据报协议

UDP 是一种保留消息边界的简单的面向数据报的传输层协议。它不提供差错纠正、队列管理、重复消除、流量控制和拥塞控制。它提供差错检测，包含我们在传输层中碰到的第一个端到端校验和。

UDP 不提供差错纠正，它把应用程序传给 IP 层的数据发送出去，但是并不保证它们能够到达目的地。另外，没有协议机制防止高速 UDP 流量对其他网络用户的消极影响。考虑到这种可靠性和保护性的缺失，我们可能会认为使用 UDP 一点好处都没有，但是这是不对的，因为它的无连接性，它要比其他传输层协议使用更少的开销。

UDP 数据报是包含 8 个字节的头部和负载数据，头部包含原端口号、目的端口号、长度、校验和，分别是 2 字节。

#### 传输控制协议

TCP 提供了一种面向连接的、可靠的字节流服务。面向连接是指使用 TCP 的两个应用程序在收发数据之前需要通过 “三次握手” 来建立逻辑连接。TCP 提供一种字节流抽象概念给应用程序使用，这种设计方案的结果是，没有由 TCP 自动插入的记录标志或消息边界。如果应用程序在一端写入 10 字节、随后写入 20 字节，最后写入 50 字节，那么在连接的另一端应用程序是不知道每次写入的字节是多少的，它可以以每次 20 字节读取四次也可以一次性读入 80 字节。TCP 根本不会解读字节流里的字节内容，它不知道正在交换的数据字节是不是二进制数据还是其他 ASCII 等等。对这个字节流的读取取决于连接中每个端点的应用程序。

TCP 维持了一个强制的校验和，该校验和涉及它的头部、任何相关应用程序数据和 IP 头部的所有字段。如果一个带无效检验和的报文段到达，那么 TCP 会丢弃它，不为被丢弃的分组发送任何确认。然后，TCP 接收端可能会对一个以前的（已经确认的）报文段进行确认，以帮助发送方计算它的拥塞控制。

当 TCP 发送一组报文段时，它通常设置一个重传计时器，等待对方的确认接收。TCP 不会为每个报文段设置一个不同的重传计时器。相反，发生一个窗口的数据，它只设置一个计时器，当 ACK 到达时再更新超市。如果有一个确认没有及时接收到，这个报文段就会被重传。

TCP 给应用程序提供一种双工服务，这就是说数据可向两个方向流动，两个方向互相独立。因此，连接的每个端点必须对每个方向维持数据流的一个序列号。使用序列号，一个 TCP 接收端可丢弃重复的报文段和记录以杂乱次序到达的报文段。TCP 使用 IP 来传递它的报文段，IP 不提供重复消除或保证次序正确的功能。然后，因为 TCP 是一个字节流协议，TCP 绝不对以杂乱的次序给接收应用程序发送数据。因此，TCP 接收端可能会被迫先保持大序列号的数据不交给应用程序，知道缺失的小序列号报文段到达。

TCP 报文段包含 20 字节（不带选项）的头部和负载。

#### TCP 连接管理

TCP 连接建立过程：

1. 客户端发送一个 SYN 报文段（即一个在 TCP 头部的 SYN 位字段置位的 TCP/IP 数据包），并指明自己想要连接的端口号和它的客户端初始序列号（记为 ISN(c)）。通常，客户端还会借此发送一个或多个选项，客户端发送的这个 SYN 报文段称作段 1。
2. 服务器也发送自己的 SYN 报文段作为响应，并包含了它的初始序列号（记做 ISN(s)），该段成为段 2。此外，为了确认客户端的 SYN，服务端将其包含的 ISN(c) 数值加 1 后作为返回的 ACK 数值。因此，每发送一个 SYN，序列号就会自动加 1，这样如果出现丢失的情况，该 SYN 段将会重传。
3. 为了确认服务端的 SYN，客户端将 ISN(s) 的数值加 1 后作为返回的 ACK 数值，称为段 3。

通过发送上述 3 个报文段就能够完成一个 TCP 连接的建立。它们也被称作三次握手，三次握手的目的不仅在于让通信双方了解一个连接正在建立，还在于利用数据包的选项来承载特殊信息，交换初始序列号。

TCP 连接的任何一方都能够发起一个关闭操作，连接关闭过程：

1. 连接的主动关闭者发送一个 FIN 段指明接收者希望看到自己当前的序列号（如 K）。FIN 段还包含一个 ACK 段用来确认对方最近一次发来的数据（如 L）。
2. 连接的被动关闭者将 K 的数值加 1 作为响应的 ACK 值，以表明它已经成功接收到主动关闭者发送的 FIN。此时，上层的应用程序会被告知连接的另一端已经提出了关闭的请求。通常，这将导致应用程序发起自己的关闭操作。接着，被动关闭者将身份转变为主动关闭者，发生自己的 FIN，该报文段的序列号为 L。
3. 为了完成连接的关闭，最后发送的报文段还包含一个 ACK 用于确认上一个 FIN。值得注意的是，如果出现了 FIN 丢失的情况，那么发送方将重新传输直到接收到一个 ACK 确认为止。

