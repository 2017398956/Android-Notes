---
崩溃优化
---

#### 目录

1. Android 的两种崩溃
2. 如何衡量崩溃
2. ANR
2. 参考

#### Android 的两种崩溃

Android 崩溃分为 Java 崩溃和 Native 崩溃。

简单来说，Java 崩溃就是在 Java 代码中，出现了未捕获异常，导致程序异常退出。那么 Native 崩溃又是怎么产生的呢？一般都是因为在 Native 代码中访问非法地址，也可能是地址对齐出现了问题，或者发生了程序主动 abort，这些都会产生对应的 signal 信号，导致程序异常退出。

##### Java 崩溃

通过实现 UncaughtExceptionHandler 接口，来处理未捕获的异常。

##### Native 崩溃

使用 [Breakpad](https://chromium.googlesource.com/breakpad/breakpad/+/master) 开源项目。

#### ANR

**ANR 的信息收集过程**

当发生 ANR 的时候，会开启一个 AnrConsumer 的线程去处理 ANR，这个线程主要做的事情就是收集一些现场信息，比如当前进程名、进程的 pid、以及发生 ANR 的原因，剩下的就是 ProcessCpuTracker 输出的一些关键信息，包括 CPU 负载、内存使用率以及进程列表中各个线程的用户时间和系统时间占比等等。然后输出 logcat、写入 traces 文件，最后根据是否是前台进程来决定是否弹一个 ANR 弹窗。这里需要注意的是，写入 trace 文件是包含许多进程的 trace 信息的，因为产生 ANR 的原因有可能是其他进程抢占了太多资源，或者 IPC 到其他进程（尤其是系统进程）的时候卡住导致的。

**ANR 监控**

监控 ANR 通常有两种做法：

- 使用 FileObserver 监听 /data/anr/traces.txt 的变化

  不过高版本系统已经没有读取这个文件的权限了，同时高版本系统也不再是只能生成一个 traces 文件了，而是可以生成多个带时间戳的 traces 文件，可以使用 adb bugreport 导出 traces 文件本地分析。

- 监控消息队列的运行时间

  这个在卡顿优化里面提到过，完全可以看成是对卡顿 5 秒的监控，所以基于 Looper Printer 的方案也是可以用的。除此之外，[ANR-WatchDog](https://github.com/SalomonBrys/ANR-WatchDog) 也是类似原理。它是通过在一个工作线程中，用主线程的 Handler post 一个消息，然后这个线程直接 sleep 5s，sleep 之后看看标志位是否被修改，如果没被修改就说明主线程卡顿了 5s，即发生了 ANR。



#### 参考

[崩溃优化（下）：应用崩溃了，你应该如何去分析？](https://time.geekbang.org/column/article/70966)

[崩溃优化（上）：关于崩溃那些事儿](https://time.geekbang.org/column/article/70602)

[微信 Android 客户端的 ANR 监控方案](https://mp.weixin.qq.com/s?__biz=MzAwNDY1ODY2OQ==&mid=2649288031&idx=1&sn=91c94e16460a4685a9c0c8e1b9c362a6&chksm=8334c9ddb44340cb66e6ce512ca41592fb483c148419737dbe21f9bbc2bfc2f872d1e54d1641&scene=178&cur_album_id=1955379810352840707#rd)

[https://developer.android.com/topic/performance/vitals/anr](https://developer.android.com/topic/performance/vitals/anr)

[https://developer.android.com/about/versions/11/features#app-process-exit-reasons](https://developer.android.com/about/versions/11/features#app-process-exit-reasons)

[理解 Android ANR 的信息收集过程](http://gityuan.com/2016/12/02/app-not-response/)

[滴滴出行安卓端 finalize time out 的解决方案](https://www.infoq.cn/article/NxlcJikbFaoTeACHxMQk)

[剖析 SharedPreference app 引起的 ANR 问题](https://mp.weixin.qq.com/s/IFgXvPdiEYDs5cDriApkxQ)

[深入探索 Android 卡顿优化（下）](https://juejin.cn/post/6844904066259091469)

[美团外卖 Android Crash 治理之路](https://mp.weixin.qq.com/s?__biz=MjM5NjQ5MTI5OA==&mid=2651748107&idx=1&sn=55dff1b286e92cfb6aaee776df8ec89e&chksm=bd12ae468a652750a7624c30eca56f6f83347b16cdfb9153b647c6e5229a822b16724a1bbd9d&scene=38#wechat_redirect)

[https://github.com/SalomonBrys/ANR-WatchDog](https://github.com/SalomonBrys/ANR-WatchDog)